trigger:
- main

pool:
  name: Default  # Self-hosted Agent ã®åå‰

steps:
- checkout: self

# ğŸ” ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç’°å¢ƒå¤‰æ•°ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
- script: |
    echo ğŸ” [Build Info]
    echo Build.SourceBranch: %BUILD_SOURCEBRANCH%
    echo Build.Reason: %BUILD_REASON%
    echo Build.RequestedFor: %BUILD_REQUESTEDFOR%
    echo Build.RequestedForEmail: %BUILD_REQUESTEDFOREMAIL%
    echo Agent.Name: %AGENT_NAME%
    echo Agent.OS: %AGENT_OS%
    echo Agent.MachineName: %AGENT_MACHINENAME%
    echo System.TeamProject: %SYSTEM_TEAMPROJECT%
    echo System.CollectionUri: %SYSTEM_COLLECTIONURI%
  displayName: 'ğŸ” Show Pipeline Context'

# âš™ï¸ Terraform å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ï¼ˆinit â†’ plan â†’ applyï¼‰
- script: |
    echo "ğŸ“‚ cd terraform/"
    cd terraform

    echo "â–¶ terraform init"
    terraform init

    echo "â–¶ terraform plan"
    terraform plan || echo "âš ï¸ terraform plan failed (äºˆæƒ³ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼ã‹ã‚‚)"

    echo "â–¶ terraform apply"
    terraform apply -auto-approve || echo "âŒ terraform apply failedï¼ˆæƒ³å®šé€šã‚Šãªã‚‰OKï¼‰"
  displayName: 'âš™ï¸ Run Terraform'
