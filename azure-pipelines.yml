# subscription-api / azure-pipelines.yml
trigger: none
pr: none

pool:
  name: Default

variables:
  - name: System.Debug
    value: 'true'

stages:
# =========================================================
# Stage0: Subscription (Create via AzAPI)
#   - tfvars/alias 無ければ失敗させず RUN_LATER を出力して早期 return
#   - alias があれば apply せず subscriptionId を取得
#   - alias 無ければ Terraform で alias 作成 → subscriptionId を取得
# =========================================================
- stage: stage0_subscription
  displayName: "Stage0 - Create Subscription (AzAPI)"
  jobs:
  - job: run_tf
    displayName: "Terraform apply (subscription)"
    steps:
    - powershell: |
        Write-Host "Agent Name  : $env:AGENT_NAME"
        Write-Host "Agent OS    : $env:AGENT_OS"
        Write-Host "Agent Ver   : $env:AGENT_VERSION"
        Write-Host "Src Dir     : $(Build.SourcesDirectory)"
      displayName: "Show Agent Info"

    - task: AzureCLI@2
      displayName: "WHOAMI (service connection identity)"
      inputs:
        azureSubscription: 'snp-pipeline-api'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          $ErrorActionPreference = 'Stop'
          $clientId = az account show --query user.name -o tsv
          $tenantId = az account show --query tenantId -o tsv
          $subName  = az account show --query name -o tsv
          $subId    = az account show --query id -o tsv

          $sp      = az ad sp show --id $clientId --only-show-errors
          $spJson  = $sp | ConvertFrom-Json
          $spObjId = $spJson.id
          $spName  = $spJson.displayName

          Write-Host "== Service Connection =="
          Write-Host "tenantId    : $tenantId"
          Write-Host "subscription: $subName ($subId)"
          Write-Host "clientId    : $clientId"
          Write-Host "spObjectId  : $spObjId"
          Write-Host "spName      : $spName"
          Write-Host ""
          Write-Host "== Current role assignments for this SP (all scopes) =="
          az role assignment list --assignee $spObjId --all -o table

    - task: AzureCLI@2
      name: tf
      displayName: 'Terraform init/plan/apply (Stage0)'
      inputs:
        azureSubscription: 'snp-pipeline-api'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          function Resolve-StageDir {
            param([string]$base)
            $p1 = Join-Path $base 'terraform\stage0-subscription'
            $p2 = Join-Path $base 'subscription-api\terraform\stage0-subscription'
            if (Test-Path -LiteralPath $p1) { return $p1 }
            if (Test-Path -LiteralPath $p2) { return $p2 }
            return $p1 # デフォルト
          }

          $stageDir = Resolve-StageDir -base "$(Build.SourcesDirectory)"
          $tfvars   = Join-Path $stageDir 'terraform.tfvars'
          Write-Host "Stage0 stageDir = $stageDir"
          Write-Host "Stage0 tfvars   = $tfvars"

          function Get-AliasNameFromTfvars([string]$Path) {
            if (-not (Test-Path -LiteralPath $Path)) { return "" }
            $line = Get-Content -LiteralPath $Path | Where-Object { $_ -match '^\s*subscription_alias_name\s*=' } | Select-Object -First 1
            if ($line) { return ($line -replace '^\s*subscription_alias_name\s*=\s*"?([^"]+)"?\s*$', '$1') }
            return ""
          }

          function Get-SubIdViaAz([string]$AliasName) {
            if ([string]::IsNullOrWhiteSpace($AliasName)) { return "" }
            try {
              $id = az account alias show --name $AliasName --query "properties.subscriptionId" -o tsv 2>$null
              if ($LASTEXITCODE -eq 0 -and $id) { return $id.Trim() }
            } catch {}
            try {
              $rid = "/providers/Microsoft.Subscription/aliases/$AliasName"
              $id = az resource show --ids $rid --api-version 2021-10-01 --query "properties.subscriptionId" -o tsv 2>$null
              if ($LASTEXITCODE -eq 0 -and $id) { return $id.Trim() }
            } catch {}
            return ""
          }

          function Wait-SubscriptionReady([string]$AliasName, [int]$MaxSeconds, [int]$IntervalSeconds) {
            $deadline = (Get-Date).AddSeconds($MaxSeconds)
            while ((Get-Date) -lt $deadline) {
              $id = ""
              try {
                $id = az account alias show --name $AliasName --query "properties.subscriptionId" -o tsv 2>$null
                if ($LASTEXITCODE -eq 0 -and $id) { return $id.Trim() }
              } catch {}
              try {
                $rid = "/providers/Microsoft.Subscription/aliases/$AliasName"
                $id = az resource show --ids $rid --api-version 2021-10-01 --query "properties.subscriptionId" -o tsv 2>$null
                if ($LASTEXITCODE -eq 0 -and $id) { return $id.Trim() }
              } catch {}
              Start-Sleep -Seconds $IntervalSeconds
            }
            return ""
          }

          # === tfvars 存在チェック（無ければ RUN_LATER を出力して早期 return）===
          if (-not (Test-Path -LiteralPath $tfvars)) {
            Write-Host "WARN: terraform.tfvars not found: $tfvars"
            Write-Host ("##vso[task.setvariable variable=subscriptionAlias;isOutput=true]")
            Write-Host ("##vso[task.setvariable variable=subscriptionId;isOutput=true]RUN_LATER")
            Write-Host "INFO: Stage0 ended with RUN_LATER due to missing tfvars."
            return
          }

          $aliasName = Get-AliasNameFromTfvars -Path $tfvars
          if ([string]::IsNullOrWhiteSpace($aliasName)) {
            Write-Host "WARN: subscription_alias_name is empty in tfvars."
            Write-Host ("##vso[task.setvariable variable=subscriptionAlias;isOutput=true]")
            Write-Host ("##vso[task.setvariable variable=subscriptionId;isOutput=true]RUN_LATER")
            Write-Host "INFO: Stage0 ended with RUN_LATER due to empty alias."
            return
          }

          # 次段でも参照できるよう alias を出力
          Write-Host ("##vso[task.setvariable variable=subscriptionAlias;isOutput=true]" + $aliasName)

          # まず alias 存在チェック
          $existingSubId = Get-SubIdViaAz -AliasName $aliasName
          if ($existingSubId) {
            Write-Host "Alias already exists. Skip Terraform. alias=$aliasName subId=$existingSubId"
            try {
              Push-Location $stageDir
              terraform init
              $rid = "/providers/Microsoft.Subscription/aliases/$aliasName"
              terraform import -no-color azapi_resource.subscription $rid 2>$null
              if ($LASTEXITCODE -ne 0) { Write-Host "terraform import skipped (not critical)." }
            } catch {
              Write-Host "terraform import failed but ignored."
            } finally {
              Pop-Location
            }

            Write-Host ("subscriptionId=" + $existingSubId)
            Write-Host ("##vso[task.setvariable variable=subscriptionId;isOutput=true]" + $existingSubId)
            Write-Host "INFO: Resolved subscriptionId (existing)."
            return
          }

          # === alias が無ければ作成 ===
          try {
            Push-Location $stageDir
            terraform init
            terraform plan -var-file="$tfvars" -out plan.out
            terraform apply -auto-approve plan.out
          } finally {
            Pop-Location
          }

          # output → 取得できなければ 6 分輪読
          $subId = ""
          try { $subId = terraform -chdir="$stageDir" output -raw subscription_id } catch {}
          if (-not $subId) {
            $subId = Wait-SubscriptionReady -AliasName $aliasName -MaxSeconds 360 -IntervalSeconds 10
          }

          if ($subId) {
            Write-Host ("subscriptionId=" + $subId)
            Write-Host ("##vso[task.setvariable variable=subscriptionId;isOutput=true]" + $subId)
            Write-Host "INFO: Resolved subscriptionId (created)."
          } else {
            Write-Host "WARN: subscriptionId not resolved in Stage0 (alias may still be provisioning)."
            Write-Host ("##vso[task.setvariable variable=subscriptionId;isOutput=true]RUN_LATER")
            Write-Host "INFO: Stage0 ended with RUN_LATER."
          }

    # Stage0 出力の可視化（一行で空判定が分かる）
    - powershell: |
        $a = "$(tf.subscriptionAlias)"; if ([string]::IsNullOrWhiteSpace($a)) { $a = "[EMPTY]" }
        $s = "$(tf.subscriptionId)";    if ([string]::IsNullOrWhiteSpace($s)) { $s = "[EMPTY]" }
        Write-Host "[Stage0] alias=$a  subId=$s"
      displayName: "Echo Stage0 outputs (debug)"

# =========================================================
# Stage1〜4: 下流（subscriptionId が RUN_LATER または空なら停止）
# 各ステージの最初に一行の空判定エコーを入れて可視化
# =========================================================
- stage: stage1_rg
  displayName: "Stage1 - Resource Group"
  dependsOn: stage0_subscription
  variables:
    subscriptionIdFromStage0: $[ stageDependencies.stage0_subscription.run_tf.outputs['tf.subscriptionId'] ]
    subscriptionAlias:        $[ stageDependencies.stage0_subscription.run_tf.outputs['tf.subscriptionAlias'] ]
  condition: and(succeeded(), ne(variables['subscriptionIdFromStage0'], 'RUN_LATER'), ne(variables['subscriptionIdFromStage0'], ''))
  jobs:
  - job: apply_rg
    displayName: "RG作成"
    steps:
    - powershell: |
        $sid = "$(subscriptionIdFromStage0)"; if ([string]::IsNullOrWhiteSpace($sid)) { $sid = "[EMPTY]" }
        $als = "$(subscriptionAlias)";        if ([string]::IsNullOrWhiteSpace($als)) { $als = "[EMPTY]" }
        Write-Host "[Stage1] subId=$sid alias=$als"
      displayName: "Echo subId/alias (debug)"

    - task: AzureCLI@2
      displayName: "Terraform apply (Stage1 RG)"
      inputs:
        azureSubscription: 'snp-pipeline-api'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          $ErrorActionPreference = 'Stop'
          az account set --subscription "$(subscriptionIdFromStage0)"
          Write-Host "Using subscription: $(subscriptionIdFromStage0)"
          $env:ARM_USE_AZCLI_AUTH = "true"
          $dir1 = "$(Build.SourcesDirectory)\terraform\stage1-rg"
          $dir2 = "$(Build.SourcesDirectory)\subscription-api\terraform\stage1-rg"
          $dir  = (Test-Path $dir1) ? $dir1 : $dir2
          Push-Location $dir
          try {
            terraform init -no-color
            terraform apply -auto-approve -no-color
          } finally {
            Pop-Location
          }

- stage: stage2_vnet
  displayName: "Stage2 - VNet"
  dependsOn: stage1_rg
  variables:
    subscriptionIdFromStage0: $[ stageDependencies.stage0_subscription.run_tf.outputs['tf.subscriptionId'] ]
  condition: and(succeeded(), ne(variables['subscriptionIdFromStage0'], 'RUN_LATER'), ne(variables['subscriptionIdFromStage0'], ''))
  jobs:
  - job: apply_vnet
    displayName: "VNet作成"
    steps:
    - powershell: |
        $sid = "$(subscriptionIdFromStage0)"; if ([string]::IsNullOrWhiteSpace($sid)) { $sid = "[EMPTY]" }
        Write-Host "[Stage2] subId=$sid"
      displayName: "Echo subId (debug)"

    - task: AzureCLI@2
      displayName: "Terraform apply (Stage2 VNet)"
      inputs:
        azureSubscription: 'snp-pipeline-api'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          $ErrorActionPreference = 'Stop'
          az account set --subscription "$(subscriptionIdFromStage0)"
          Write-Host "Using subscription: $(subscriptionIdFromStage0)"
          $env:ARM_USE_AZCLI_AUTH = "true"
          $dir1 = "$(Build.SourcesDirectory)\terraform\stage2-vnet"
          $dir2 = "$(Build.SourcesDirectory)\subscription-api\terraform\stage2-vnet"
          $dir  = (Test-Path $dir1) ? $dir1 : $dir2
          Push-Location $dir
          try {
            terraform init -no-color
            terraform apply -auto-approve -no-color
          } finally {
            Pop-Location
          }

- stage: stage3_subnet
  displayName: "Stage3 - Subnet"
  dependsOn: stage2_vnet
  variables:
    subscriptionIdFromStage0: $[ stageDependencies.stage0_subscription.run_tf.outputs['tf.subscriptionId'] ]
  condition: and(succeeded(), ne(variables['subscriptionIdFromStage0'], 'RUN_LATER'), ne(variables['subscriptionIdFromStage0'], ''))
  jobs:
  - job: apply_subnet
    displayName: "Subnet + NSG + 関連付け"
    steps:
    - powershell: |
        $sid = "$(subscriptionIdFromStage0)"; if ([string]::IsNullOrWhiteSpace($sid)) { $sid = "[EMPTY]" }
        Write-Host "[Stage3] subId=$sid"
      displayName: "Echo subId (debug)"

    - task: AzureCLI@2
      displayName: "Terraform apply (Stage3 Subnet)"
      inputs:
        azureSubscription: 'snp-pipeline-api'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          $ErrorActionPreference = 'Stop'
          az account set --subscription "$(subscriptionIdFromStage0)"
          Write-Host "Using subscription: $(subscriptionIdFromStage0)"
          $env:ARM_USE_AZCLI_AUTH = "true"
          $dir1 = "$(Build.SourcesDirectory)\terraform\stage3-subnet"
          $dir2 = "$(Build.SourcesDirectory)\subscription-api\terraform\stage3-subnet"
          $dir  = (Test-Path $dir1) ? $dir1 : $dir2
          Push-Location $dir
          try {
            terraform init -no-color
            terraform apply -auto-approve -no-color
          } finally {
            Pop-Location
          }

# 参考: Stage4 は無効
- stage: stage4a_peering_s2h
  displayName: "Stage4a - Peering Spoke->Hub"
  dependsOn: stage3_subnet
  condition: false
  jobs:
  - job: placeholder_peering_s2h
    steps:
    - powershell: |
        Write-Host "[PEERING S->H] placeholder"

- stage: stage4b_peering_h2s
  displayName: "Stage4b - Peering Hub->Spoke"
  dependsOn: stage4a_peering_s2h
  condition: false
  jobs:
  - job: placeholder_peering_h2s
    steps:
    - powershell: |
        Write-Host "[PEERING H->S] placeholder"
